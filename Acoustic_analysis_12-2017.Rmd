---
title: "Acoustic analysis"
author: "Elan Portner"
date: "12/3/2017"
output: html_document
---


```{r get necessary packages, include = FALSE}
# 1) clear workspace
rm(list = ls(all = TRUE)); 

# 2) load packages: (fyi, you probably don't need all of these for this code, but good ones to have for spatial R stuff...)
## if you need to install any, uncomment and run (shown are some examples below)...

library(ncdf4); library(ncdf)
library(RNetCDF)
library(raster)
library(maps)
library(mapdata)
library(maptools)
library(rgdal)
library(move)
library(mapproj)
library(sp)
require(dismo)
library(ggplot2)
library(ggmap)
library(RColorBrewer)
library(reshape2)
library(mapplots)
library(rgeos)
library(polyclip)
library(spatstat)
library(tidyverse)
library(Rmisc)

```



```{r get_data, include = FALSE}
#read in data file - see "~/Assigning_regions_to_acoustics.R" for code to assign data to regions
acoustics = read.csv("~/Documents/R/Dosidicus/acoustics/acousticdata_uper200m_with_regions.csv") 
acousticdata = acoustics
### remove outliers for preliminary figure to improve visualization###
I = which(log(acousticdata$NASC)>12|log(acousticdata$NASC)<0)
acousticdata = acousticdata[-I,]
acousticdata$fill = 1
### 9 data points removed with above code ###
```


```{r plot_cruise_track,include = FALSE}
library(ggmap)
library(ggplot2)
##### plot google map overlaid with cruise tracks ######

#need to convert longitude back to E/W for plotting map with google
acousticdata$Lon_M = acousticdata$Lon_M - 360

#set bounds of map using coordinates of our data
bc_bbox <- make_bbox(lat = Lat_M, lon = Lon_M, data = acousticdata)
bc_bbox
#>       left     bottom      right        top 
#> -133.63297   47.92497 -122.33652   55.80833

# grab the maps from google
bc_big <- get_map(location = c(left =-117.04904, bottom = 22.41260, right = -104.20950, top = 34.77702), source = "google", maptype = "satellite")
#> Warning: bounding box given to google - spatial extent only approximate.
#> converting bounding box to center/zoom specification. (experimental)
#> Map from URL : http://maps.googleapis.com/maps/api/staticmap?center=51.86665,-127.98475&zoom=6&size=640x640&scale=2&maptype=terrain&language=en-EN&sensor=false


```

## Map of cruise track
```{r, echo = FALSE, warning = FALSE}
# plot the points and color them by sector
p <- ggmap(bc_big) + 
  geom_point(data = acousticdata, mapping = aes(x = Lon_M, y = Lat_M, color = region), size = 0.3, stroke = 0, alpha = 0.9)+
  guides(colour = guide_legend(override.aes = list(size=2, stroke=1.5)))

p

```

#### Data was subsetted by time of day (nighttime = 7pm-6am)
### Boxplot of logNASC by cruise*region for data extracted from upper water column (10-200m) in 1km chunks
```{r summary_boxplot, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9}
### create vector of simplified labels 
cruises = c("", "", "W.05", "","", "", "W.07", "","", "", "S.07", "",
            "", "", "W.10", "","", "", "W.11", "","", "", "S.12", "",
            "", "", "S.13", "","", "", "W.14", "","", "", "S.14", "",
            "", "", "S.16", "","", "", "S.17", "")

# Plot boxplots of scattering area within each polygon by cruise 
cruisePoly <- ggplot(acousticdata, aes(cpoly, log(NASC), fill = region)) + geom_boxplot() 
cruisePoly = cruisePoly +scale_x_discrete(labels = cruises)+theme(axis.text.x=element_text(hjust=1))
cruisePoly = cruisePoly + labs(x="Cruise (Season.Year, where W = winter and S = summer)")
cruisePoly
```


```{r anova, echo=FALSE, include = FALSE}
###### run ANOVA(s) to examine with explanatory variables significantly affect backscattering
acousticdata$season = as.factor(acousticdata$season)
acousticdata$region = as.factor(acousticdata$region)
acousticdata$year = as.factor(acousticdata$year)
```

### ANOVA model: (NASC ~ season*region*year)
```{r}
aov.acoustics.nasc <- aov(NASC ~ season*region*year, data = acousticdata)
summary(aov.acoustics.nasc)
```


## Plot mean Sv by cruise
```{r, echo = FALSE, warning = FALSE, message=FALSE, fig.width=9, fig.height=9}
cruise_plot <- function(cruse, seas, yr){ # cntry <- "Canada"
  
  #browser()
#   png <- paste0("cruise", cruse, ".png")
#   cat("cruise_plot(", cruse, ") -> ", png, "\n")
#   
  g <- acousticdata %>%
    filter(cruise == cruse) %>%
    ggplot(aes(x=Sv_mean, group = cruise, fill = region)) +
    geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 5, 
                   position = "identity", alpha = 0.2, color = "black") +
    scale_x_continuous(limits = c(-90, -50))+
    scale_y_continuous(limits = c(0, 0.7))+
    xlab("Mean Sv") + 
    ylab("Proportion")+ 
    ggtitle(paste0("Cruise", " ", cruse, " ", "-", " ", seas, " ", yr))
  # print(g)
#   ggsave(png, g)
}

fig1 <- cruise_plot("1", "Winter", "2005")
fig2 <- cruise_plot("2", "Winter", "2007")
fig3 <- cruise_plot("3", "Summer", "2007")
fig4 <- cruise_plot("4", "Winter", "2010")
fig6 <- cruise_plot("6", "Winter", "2011")
fig7 <- cruise_plot("7", "Summer", "2012")
fig8 <- cruise_plot("8", "Summer", "2013")
fig9 <- cruise_plot("9", "Winter", "2014")
fig10 <- cruise_plot("10", "Summer", "2014")
fig11 <- cruise_plot("11", "Summer", "2016")
fig12 <- cruise_plot("12", "Summer", "2017")

multiplot(fig1, fig2, fig3, fig4, fig6, fig7, fig8, fig9, fig10, fig11, fig12, cols = 3)

```

### ANOVA model: (Sv_mean ~ cruise*region)
```{r}
aov.acoustics.sv2 <- aov(Sv_mean ~ cruise*region, data = acousticdata)
summary(aov.acoustics.sv2)
```

### ANOVA model: (Sv_mean ~ season*region*year)
```{r}
aov.acoustics.sv <- aov(Sv_mean ~ season*region*year, data = acousticdata)
summary(aov.acoustics.sv)
```

### Mean Sv by region, by cruise : Baja

```{r by_region, echo = FALSE, warning = FALSE, message=FALSE, fig.width=9, fig.height=9}
cruise_plot <- function(cruse, reg, seas, yr){ # cntry <- "Canada"
  
  #browser()
#   png <- paste0("cruise", cruse, ".png")
#   cat("cruise_plot(", cruse, ") -> ", png, "\n")
#   
  g <- acousticdata %>%
    filter(cruise == cruse) %>%
    filter(region == reg) %>% 
    ggplot(aes(x=Sv_mean, group = cruise)) +
    geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 3, 
                   position = "identity", alpha = 0.2, color = "black", fill = "red") +
    scale_x_continuous(limits = c(-90, -50))+
    scale_y_continuous(limits = c(0, 0.55))+
    xlab("Mean Sv") + 
    ylab("Proportion")+ 
    ggtitle(paste0("Cruise", " ", cruse, " ", "-", " ", seas, " ", yr))
  # print(g)
#   ggsave(png, g)
}

fig1 <- cruise_plot("1", "Baja", "Winter", "2005")
fig2 <- cruise_plot("2", "Baja","Winter", "2007")
fig3 <- cruise_plot("3", "Baja","Summer", "2007")
fig4 <- cruise_plot("4", "Baja","Winter", "2010")
fig6 <- cruise_plot("6", "Baja","Winter", "2011")
fig7 <- cruise_plot("7", "Baja","Summer", "2012")
fig8 <- cruise_plot("8", "Baja","Summer", "2013")
fig9 <- cruise_plot("9", "Baja","Winter", "2014")
fig10 <- cruise_plot("10", "Baja","Summer", "2014")
fig11 <- cruise_plot("11", "Baja","Summer", "2016")
fig12 <- cruise_plot("12", "Baja","Summer", "2017")

multiplot(fig1, fig2, fig3, fig4, fig6, fig7, fig8, fig9, fig10, fig11, fig12, cols = 3)

```

### Mean Sv by region, by cruise : Sonora

```{r by_region_sonora, echo = FALSE, warning = FALSE, message=FALSE, fig.width=9, fig.height=9}
cruise_plot <- function(cruse, reg, seas, yr){ # cntry <- "Canada"
  
  #browser()
#   png <- paste0("cruise", cruse, ".png")
#   cat("cruise_plot(", cruse, ") -> ", png, "\n")
#   
  g <- acousticdata %>%
    filter(cruise == cruse) %>%
    filter(region == reg) %>% 
    ggplot(aes(x=Sv_mean, group = cruise)) +
    geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 3, 
                   position = "identity", alpha = 0.2, color = "black", fill = "blue") +
    scale_x_continuous(limits = c(-90, -50))+
    scale_y_continuous(limits = c(0, 0.55))+
    xlab("Mean Sv") + 
    ylab("Proportion")+ 
    ggtitle(paste0("Cruise", " ", cruse, " ", "-", " ", seas, " ", yr))
  # print(g)
#   ggsave(png, g)
}

fig1 <- cruise_plot("1", "Sonora", "Winter", "2005")
fig2 <- cruise_plot("2", "Sonora","Winter", "2007")
fig3 <- cruise_plot("3", "Sonora","Summer", "2007")
fig4 <- cruise_plot("4", "Sonora","Winter", "2010")
fig6 <- cruise_plot("6", "Sonora","Winter", "2011")
fig7 <- cruise_plot("7", "Sonora","Summer", "2012")
fig8 <- cruise_plot("8", "Sonora","Summer", "2013")
fig9 <- cruise_plot("9", "Sonora","Winter", "2014")
fig10 <- cruise_plot("10", "Sonora","Summer", "2014")
fig11 <- cruise_plot("11", "Sonora","Summer", "2016")
fig12 <- cruise_plot("12", "Sonora","Summer", "2017")

multiplot(fig1, fig2, fig3, fig4, fig6, fig7, fig8, fig9, fig10, fig11, fig12, cols = 3)

```

### Mean Sv by region, by cruise : Central

```{r by_region_central, echo = FALSE, warning = FALSE, message=FALSE, fig.width=9, fig.height=9}
cruise_plot <- function(cruse, reg, seas, yr){ # cntry <- "Canada"
  
  #browser()
#   png <- paste0("cruise", cruse, ".png")
#   cat("cruise_plot(", cruse, ") -> ", png, "\n")
#   
  g <- acousticdata %>%
    filter(cruise == cruse) %>%
    filter(region == reg) %>% 
    ggplot(aes(x=Sv_mean, group = cruise)) +
    geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 3, 
                   position = "identity", alpha = 0.2, color = "black", fill = "green") +
    scale_x_continuous(limits = c(-90, -50))+
    scale_y_continuous(limits = c(0, 0.55))+
    xlab("Mean Sv") + 
    ylab("Proportion")+ 
    ggtitle(paste0("Cruise", " ", cruse, " ", "-", " ", seas, " ", yr))
  # print(g)
#   ggsave(png, g)
}

fig1 <- cruise_plot("1", "Central", "Winter", "2005")
fig2 <- cruise_plot("2", "Central","Winter", "2007")
fig3 <- cruise_plot("3", "Central","Summer", "2007")
fig4 <- cruise_plot("4", "Central","Winter", "2010")
fig6 <- cruise_plot("6", "Central","Winter", "2011")
fig7 <- cruise_plot("7", "Central","Summer", "2012")
fig8 <- cruise_plot("8", "Central","Summer", "2013")
fig9 <- cruise_plot("9", "Central","Winter", "2014")
fig10 <- cruise_plot("10", "Central","Summer", "2014")
fig11 <- cruise_plot("11", "Central","Summer", "2016")
fig12 <- cruise_plot("12", "Central","Summer", "2017")

multiplot(fig1, fig2, fig3, fig4, fig6, fig7, fig8, fig9, fig10, fig11, fig12, cols = 3)

```

### Mean Sv by region, by cruise : Northern

```{r by_region_northern, echo = FALSE, warning = FALSE, message=FALSE, fig.width=9, fig.height=9}
cruise_plot <- function(cruse, reg, seas, yr){ # cntry <- "Canada"
  
  #browser()
#   png <- paste0("cruise", cruse, ".png")
#   cat("cruise_plot(", cruse, ") -> ", png, "\n")
#   
  g <- acousticdata %>%
    filter(cruise == cruse) %>%
    filter(region == reg) %>% 
    ggplot(aes(x=Sv_mean, group = cruise)) +
    geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 3, 
                   position = "identity", alpha = 0.2, color = "black", fill = "yellow") +
    scale_x_continuous(limits = c(-90, -50))+
    scale_y_continuous(limits = c(0, 0.55))+
    xlab("Mean Sv") + 
    ylab("Proportion")+ 
    ggtitle(paste0("Cruise", " ", cruse, " ", "-", " ", seas, " ", yr))
  # print(g)
#   ggsave(png, g)
}

fig1 <- cruise_plot("1", "Northern", "Winter", "2005")
fig2 <- cruise_plot("2", "Northern","Winter", "2007")
fig3 <- cruise_plot("3", "Northern","Summer", "2007")
fig4 <- cruise_plot("4", "Northern","Winter", "2010")
fig6 <- cruise_plot("6", "Northern","Winter", "2011")
fig7 <- cruise_plot("7", "Northern","Summer", "2012")
fig8 <- cruise_plot("8", "Northern","Summer", "2013")
fig9 <- cruise_plot("9", "Northern","Winter", "2014")
fig10 <- cruise_plot("10", "Northern","Summer", "2014")
fig11 <- cruise_plot("11", "Northern","Summer", "2016")
fig12 <- cruise_plot("12", "Northern","Summer", "2017")

multiplot(fig1, fig2, fig3, fig4, fig6, fig7, fig8, fig9, fig10, fig11, fig12, cols = 3)

```

## To examine changes in vertical distribution of signal, data were re-extracted in 4 vertical bins (10-50m, 50-100m, 100-150m, 150-200m) for every km of cruise track.

### of the 21827 km of cruisetack sampled, 18070 had data from all 4 vertical layers and are included below.

```{r get_50m_data , include = FALSE}
## read data
acousticdata50 = read.csv("~/Documents/R/Dosidicus/acoustics/portner_capegolcas_upper200m_by50m.csv")

### remove intervals which do not have all four layers ###
test_200m = aggregate(Layer~Interval*cruise, acousticdata50, sum)
colnames(test_200m) = c("Interval", "cruise", "Layersum")
test_200m_10 = subset(test_200m, Layersum==10)
test_merge_200m = merge(test_200m_10, acousticdata50,  by = c("Interval", "cruise"))

acousticdata50 <- test_merge_200m

test = aggregate(propNASC~cruise*region*Layer, acousticdata50, mean)
test$cpoly = paste(test$cruise, test$region, sep = "_")
test$Layer = as.factor(test$Layer)

```


```{r plot_propNASC_by_layer, echo = FALSE}
cruisePoly <- ggplot(test, aes(cpoly, propNASC,col = Layer, pch = region)) + geom_point(size=3) 
cruisePoly = cruisePoly +scale_x_discrete(labels = cruises)+theme(axis.text.x=element_text(hjust=1))
cruisePoly = cruisePoly + labs(x="Cruise (Season.Year, where W = winter and S = summer)")+ggtitle("Proportion of NASC in each vertical 50m Layer (Layer 1 = 10-50m)")
cruisePoly

```

